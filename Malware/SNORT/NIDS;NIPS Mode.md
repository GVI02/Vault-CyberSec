#snort  #malware 

##### <span class="purple-highlight-light">Description</span>

SNORT NIDS/NIPS blocks / allows traffic based on rules added to a configuration file.
Default files are located in **/etc/snort/**.

##### <span class="purple-highlight-light">Flags</span>

| Flag | Description                                                                                                                                                                                                                                                                                                    |
| ---- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -c   | Defining the configuration file                                                                                                                                                                                                                                                                                |
| -T   | Testing the configuration file                                                                                                                                                                                                                                                                                 |
| -N   | Disabble logging                                                                                                                                                                                                                                                                                               |
| -D   | Background mode.                                                                                                                                                                                                                                                                                               |
| -A   | Alert modes<br>**full**: Full alert mode. All possible information. Default mode.<br>**fast**: Alert message, timestamp, src and dst IP and ports<br>**console**: Fast style alerts on the console screen.<br>**cmg**: Basic header details with payload in hex and text format.<br>**none**: Disable alerting |
Full and Fast alert modes have no console output. Their output is saved in an **alert** file in the directory where snort is ran from.

Flags for output modification from [[Sniffer Mode]] and [[Packet Logger Mode]] also apply here.


##### <span class="purple-highlight-light">IPS mode</span>

IPS mode is activated using the -Q --daq afpacket parameters or by editing the .conf file. SNORT IPS requires at least 2 interfaces to work.

```shell
sudo snort -c /etc/snort/snort.conf -Q --daq afpacket -i eth0:eth1
```

##### <span class="purple-highlight-light">Rule Structure</span>

![[Pasted image 20250519133048.png]]

Each rule should have a type of action, protocol, source and destination IP, source and destination port and an option. Remember, Snort is in passive mode by default. So most of the time, you will use Snort as an IDS. You will need to start **inline mode** to turn on IPS mode.

Rules cannot be processed without a header. Rule options are "optional" parts. However, it is almost impossible to detect sophisticated attacks without using the rule options.

| Action | Description                                               |
| ------ | --------------------------------------------------------- |
| alert  | Generate an alert and log the packet                      |
| log    | Log the packet                                            |
| block  | Block and log the packet                                  |
| reject | Block the packet, log it and terminate the packet session |

Protocol parameter identifies the type of the protocol that filtered for the rule.
Note that Snort2 supports only four protocols filters in the rules (IP, TCP, UDP and ICMP).
###### <span class="purple-highlight-light">Filtering</span>


| Filter            | Example                       | Description                                    |
| ----------------- | ----------------------------- | ---------------------------------------------- |
| IP Address        | 192.168.1.56                  | Specific IP address                            |
| IP Network        | 192.168.1.0/24                | IP Network                                     |
| Multiple networks | [192.168.1.0/24, 10.1.1.0/24] | Multiple IP networks                           |
| Exclude network   | !192.168.1.0/24               | Exclude network from filter                    |
| Port              | 21                            | Port number                                    |
| Exclude port      | !21                           | Exclude port                                   |
| Port range        | 1:1024                        | Range all ports between 1 and 1024             |
| Port range (2)    | :1024                         | Filter all ports less than or equal to 1024    |
| Port range (3)    | 1025:                         | Filter all ports greater than or equal to 1025 |
| Port range (4)    | [21,23]                       | Filter for list of ports                       |

###### <span class="purple-highlight-light">Direction</span>

The direction operator indicates the traffic flow to be filtered by Snort. The left side of the rule shows the source, and the right side shows the destination.

- **->** Source to destination flow.
- **<>** Bidirectional flow

Note that there is no "<-" operator in Snort.

###### <span class="purple-highlight-light">Rule Options</span>

General rule options - Fundamental rule options for Snort

| Option    | Description                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Msg       | The message field is a basic prompt and quick identifier of the rule. Once the rule is triggered, the message filed will appear in the console or log. Usually, the message part is a one-liner that summarizes the event.                                                                                                                                                                                                                           |
| Sid       | Snort rule IDs (SID) come with a pre-defined scope, and each rule must have a SID in a proper format. There are three different scopes for SIDs shown below.<br><br>- <100: Reserved rules<br>- 100-999,999: Rules came with the build.<br>- >=1,000,000: Rules created by user.<br><br>Briefly, the rules we will create should have sid greater than 100.000.000. Another important point is; SIDs should not overlap, and each id must be unique. |
| Reference | Each rule can have additional information or reference to explain the purpose of the rule or threat pattern. That could be a Common Vulnerabilities and Exposures (CVE) id or external information. Having references for the rules will always help analysts during the alert and incident investigation.                                                                                                                                           |
| Rev       | Snort rules can be modified and updated for performance and efficiency issues. Rev option help analysts to have the revision information of each rule. Therefore, it will be easy to understand rule improvements. Each rule has its unique rev number, and there is no auto-backup feature on the rule history. Analysts should keep the rule history themselves. Rev option is only an indicator of how many times the rule had revisions.         |

Payload Detection rule options - Rule options that help to investigate the payload data. These options are helpful to detect specific payload patterns.

| Option       | Description                                                                                                                                                                                                                                                                                                                                                                                                             |
| ------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Content      | Payload data. It matches specific payload data by ASCII, HEX or both. It is possible to use this option multiple times in a single rule. However, the more you create specific pattern match features, the more it takes time to investigate a packet.<br><br>This rule option is case sensitive.                                                                                                                       |
| Nocase       | Disabling case sensitivity. Used for enhancing the content searches.                                                                                                                                                                                                                                                                                                                                                    |
| Fast_pattern | Prioritise content search to speed up the payload search operation. By default, Snort uses the biggest content and evaluates it against the rules. "fast_pattern" option helps you select the initial packet match with the specific value for further investigation. This option always works case insensitive and can be used once per rule. Note that this option is required when using multiple "content" options. |

Non-Payload Detection rule options - There are rule options that focus on non-payload data. These options will help create specific patterns and identify network issues.

| Option | Description                                                                                                |
| ------ | ---------------------------------------------------------------------------------------------------------- |
| ID     | Filtering the IP id field.                                                                                 |
| Flags  | Filtering the TCP flags.<br><br>- F - FIN<br>- S - SYN<br>- R - RST<br>- P - PSH<br>- A - ACK<br>- U - URG |
| Dsize  | Filtering the packet payload size.<br><br>- dsize:min<>max;<br>- dsize:>100<br>- dsize:<100                |
| Sameip | Filtering the source and destination IP addresses for duplication.                                         |
|        |                                                                                                            |
Remember, once you create a rule, it is a local rule and should be in your **local.rules** file. This file is located under **/etc/snort/rules/local.rules**.

##### <span class="blue-highlight-light">Rule Examples</span>

The following rule generates an alert every time an ICMP packet is detected.
```snort
alert icmp any any <> any any (msg: "ICMP Packet Found"; sid: 100001; rev:1;)
```

This rule will create an alert for each ICMP packet originating from the 192.168.1.56 IP address.
```snort
alert icmp 192.168.1.56 any <> any any  (msg: "ICMP Packet From "; sid: 100001; rev:1;)
```

This rule will create an alert for each ICMP packet originating from the 192.168.1.0/24 subnet.
```snort
alert icmp 192.168.1.0/24 any <> any any  (msg: "ICMP Packet Found"; sid: 100001; rev:1;)
```

This rule will create an alert for each ICMP packet originating from the 192.168.1.0/24 and 10.1.1.0/24 subnets.
```
alert icmp [192.168.1.0/24, 10.1.1.0/24] any <> any any  (msg: "ICMP Packet Found"; sid: 100001; rev:1;)
```

This rule will create an alert for each ICMP packet not originating from the 192.168.1.0/24 subnet.
```
alert icmp !192.168.1.0/24 any <> any any  (msg: "ICMP Packet Found"; sid: 100001; rev:1;)
```

This rule will create an alert for each TCP packet sent to port 21.
```
alert tcp any any <> any 21  (msg: "FTP Port 21 Command Activity Detected"; sid: 100001; rev:1;)
```

This rule will create an alert for each TCP packet not sent to port 21.
```
alert tcp any any <> any !21  (msg: "Traffic Activity Without FTP Port 21 Command Channel"; sid: 100001; rev:1;)
```

This rule will create an alert for each TCP packet sent to ports between 1-1024.
```
alert tcp any any <> any 1:1024   (msg: "TCP 1-1024 System Port Activity"; sid: 100001; rev:1;)
```

This rule will create an alert for each TCP packet sent to ports less than or equal to 1024.
```
alert tcp any any <> any :1024   (msg: "TCP 0-1024 System Port Activity"; sid: 100001; rev:1;)
```

This rule will create an alert for each TCP packet sent to source port higher than or equal to 1025.
```
alert tcp any any <> any 1025: (msg: "TCP Non-System Port Activity"; sid: 100001; rev:1;)
```

This rule will create an alert for each TCP packet sent to port 21 and 23.
```
alert tcp any any <> any [21,23] (msg: "FTP and Telnet Port 21-23 Activity Detected"; sid: 100001; rev:1;)
```

Following rules will create an alert for each HTTP packet containing the keyword "GET".

ASCII mode
```snort
alert tcp any any <> any 80  (msg: "GET Request Found"; content:"GET"; sid: 100001; rev:1;)
```

HEX mode
```snort
 alert tcp any any <> any 80  (msg: "GET Request Found"; content:"|47 45 54|"; sid: 100001; rev:1;)
```

Same rule as above but with case sensitivity disabled
```snort
alert tcp any any <> any 80  (msg: "GET Request Found"; content:"GET"; nocase; sid: 100001; rev:1;)
```

The following rule has two content options, and the fast_pattern option tells to snort to use the first content option (in this case, "GET") for the initial packet match.
```
alert tcp any any <> any 80  (msg: "GET Request Found"; content:"GET"; fast_pattern; content:"www";  sid:100001; rev:1;)
```

Filtering the IP id field.
```snort
alert tcp any any <> any any (msg: "ID TEST"; id:123456; sid: 100001; rev:1;)
```

Filter for TCP SYN flag
```snort
alert tcp any any <> any any (msg: "FLAG TEST"; flags:S;  sid: 100001; rev:1;)
```

Filtering the packet payload size between 100 and 300 bytes.
```snort
alert ip any any <> any any (msg: "SEQ TEST"; dsize:100<>300;  sid: 100001; rev:1;)
```

Filtering the source and destination IP addresses for duplication.
```snort
alert ip any any <> any any (msg: "SAME-IP TEST";  sameip; sid: 100001; rev:1;)
```

##### <span class="blue-highlight-light">Examples</span>

Run SNORT NIPS/NIPS in **cmg** alert mode
```shell
sudo snort -c /etc/snort/snort.conf -A cmg
```

Test rules without configuration file (slower performance)
```shell
sudo snort -c /etc/short/rules/local.rules -A console
```

Run SNORT NIDS in full alert mode and save traffic to local directory
```shell
sudo snort -c /etc/snort/snot.conf -A full -l .
```

Read pcap file with SNORT NIDS.
```shell
sudo snort -c /etc/snort/snort.conf -A console -r cap.pcap
```

Read list of pcap files with SNORT NIDS.
```shell
sudo snort -c /etc/snort/snort.conf -A console --pcap-list="icmp.pcap http.pcap"
```

Read pcap file with SNORT NIDS and log traffic output to file.
```shell
sudo snort -c /etc/snort/snort.conf -A full -l . -r cap.pcap
```

